<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TPS – Cotizador</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- PapaParse -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
  <!-- pdfmake -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
</head>
<body class="bg-gray-100 min-h-screen p-4">
  <h1 class="text-2xl font-bold mb-4 text-center text-sky-700">Cotizador TPS</h1>

  <div class="grid md:grid-cols-3 gap-4">
    <!-- Catálogo -->
    <section class="md:col-span-2 bg-white shadow rounded-xl p-4">
      <h2 class="text-lg font-semibold mb-2">Catálogo de Productos</h2>
      <div id="errorMsg" class="text-red-600 text-sm mb-2 hidden"></div>
      <div class="flex gap-2 mb-3">
        <input id="filterClave" class="w-1/2 border rounded p-2" placeholder="Filtrar por clave" />
        <input id="filterDesc"  class="w-1/2 border rounded p-2" placeholder="Filtrar por descripción" />
      </div>

      <div class="overflow-x-auto max-h-[420px]">
        <table class="w-full text-sm border">
          <thead>
            <tr class="bg-sky-700 text-white">
              <th class="p-2">Producto</th>
              <th class="p-2">Descripción</th>
              <th class="p-2">Precio</th>
              <th class="p-2">Añadir</th>
            </tr>
          </thead>
          <tbody id="productBody" class="divide-y"></tbody>
        </table>
      </div>

      <div class="flex justify-center items-center gap-2 mt-3">
        <button id="prevPage" class="px-3 py-1 bg-gray-200 rounded disabled:opacity-50">&lt;</button>
        <span id="pageInfo" class="text-sm"></span>
        <button id="nextPage" class="px-3 py-1 bg-gray-200 rounded disabled:opacity-50">&gt;</button>
      </div>
    </section>

    <!-- Cotización -->
    <section class="bg-white shadow rounded-xl p-4 flex flex-col">
      <h2 class="text-lg font-semibold mb-2">Resumen de Cotización</h2>
      <div class="space-y-2 mb-2 overflow-y-auto max-h-56 pr-2">
        <input id="cliente"   class="w-full border rounded p-2" placeholder="Nombre del cliente" />
        <input id="fecha"     type="date" class="w-full border rounded p-2" />
        <input id="whatsapp"  class="w-full border rounded p-2" placeholder="WhatsApp" />
        <input id="folio"     class="w-full border rounded p-2" placeholder="Folio (opcional)" />
        <textarea id="comentario" rows="2" class="w-full border rounded p-2" placeholder="Comentario"></textarea>
      </div>

      <label for="nivelPrecio" class="text-sm font-medium mb-1">Nivel de precio</label>
      <select id="nivelPrecio" class="border rounded p-2 mb-3">
        <option value="0">Público</option>
        <option value="0.15">Sub‑distribuidor (‑15 %)</option>
        <option value="0.20">Distribuidor (‑20 %)</option>
      </select>

      <div class="overflow-x-auto flex-1">
        <table class="w-full text-xs border">
          <thead>
            <tr class="bg-sky-700 text-white text-center">
              <th class="p-1">#</th>
              <th class="p-1">Producto</th>
              <th class="p-1">Descripción</th>
              <th class="p-1">Cant</th>
              <th class="p-1">P.Unit</th>
              <th class="p-1">Importe</th>
            </tr>
          </thead>
          <tbody id="cartBody" class="divide-y text-center">
            <tr><td colspan="6" class="p-2 italic text-gray-500">Añade productos…</td></tr>
          </tbody>
        </table>
      </div>

      <div class="text-right mt-2 text-sm space-y-1">
        <div>Subtotal: <span id="subTotal">$0.00</span></div>
        <div>IVA 16 %: <span id="iva">$0.00</span></div>
        <div class="font-semibold text-lg">Total: <span id="total">$0.00</span></div>
      </div>

      <div class="flex gap-2 mt-4">
        <button id="btnWhats" class="flex-1 bg-green-500 hover:bg-green-600 text-white rounded p-2">WhatsApp</button>
        <button id="btnPDF"  class="flex-1 bg-sky-600   hover:bg-sky-700   text-white rounded p-2">Generar PDF</button>
      </div>
    </section>
  </div>

<script>
/*************  CONFIG  *************/
const CSV_URL       = 'https://raw.githubusercontent.com/raulancona/cotizadortps/main/Lista%20estandar%20Raul.csv';
const ROWS_PER_PAGE = 10;
let products = [], filtered = [], currentPage = 1, cart = [];
const $ = id => document.getElementById(id);
const money = n => n.toLocaleString('es-MX', { style:'currency', currency:'MXN' });

/*************  CSV LOAD  *************/
function loadCSV(){
  Papa.parse(CSV_URL,{
    download:true,
    header:true,
    skipEmptyLines:true,
    complete: res=>{
      products = res.data.map(r=>({
        producto   : (r['producto']      || r['Producto']      || '').trim(),
        descripcion: (r['Descripción ']   || r['Descripción']   || r['descripcion'] || '').trim(),
        precio     : parseFloat(String(r[' Precio ']|| r['Precio'] || r['precio'] || '0').replace(/[$,]/g,''))||0
      })).filter(p=>p.producto && !isNaN(p.precio));
      if(!products.length){ showError('No se encontraron productos válidos en el CSV.'); return; }
      filtered = [...products];
      renderProducts();
    },
    error: err=> showError('Error al cargar catálogo: '+err.message)
  });
}
function showError(msg){ const box=$('errorMsg'); box.textContent=msg; box.classList.remove('hidden'); }

/*************  PRODUCT LIST  *************/
function renderProducts(){
  const tbody = $('productBody'); tbody.innerHTML='';
  const pages = Math.max(1, Math.ceil(filtered.length/ROWS_PER_PAGE));
  currentPage = Math.min(currentPage, pages);
  const start = (currentPage-1)*ROWS_PER_PAGE;
  filtered.slice(start, start+ROWS_PER_PAGE).forEach(p=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `<td class="p-1">${p.producto}</td>
      <td class="p-1 text-left">${p.descripcion}</td>
      <td class="p-1 text-right">${money(p.precio)}</td>
      <td class="p-1 text-center"><button class="bg-sky-600 hover:bg-sky-700 text-white rounded px-2 py-1 text-xs" data-prod="${p.producto}">+</button></td>`;
    tbody.appendChild(tr);
  });
  $('pageInfo').textContent = `Página ${currentPage} / ${pages}`;
  $('prevPage').disabled = currentPage===1;
  $('nextPage').disabled = currentPage===pages;
  tbody.querySelectorAll('button[data-prod]').forEach(btn=>btn.onclick = ()=>addToCart(btn.dataset.prod));
}
function filterProducts(){
  const clave = $('filterClave').value.trim().toLowerCase();
  const desc  = $('filterDesc').value.trim().toLowerCase();
  filtered = products.filter(p => (!clave||p.producto.toLowerCase().includes(clave)) && (!desc||p.descripcion.toLowerCase().includes(desc)) );
  currentPage = 1;
  renderProducts();
}

/*************  CART  *************/
function addToCart(code){
  const prod = products.find(p=>p.producto===code); if(!prod) return;
  const line = cart.find(l=>l.producto===code);
  if(line){ line.cantidad++; }
  else { cart.push({ ...prod, cantidad:1 }); }
  recalcCart();
}
function recalcCart(){
  const descuento = parseFloat($('nivelPrecio').value);
  cart.forEach(l=>{
    l.precioDesc = l.precio*(1-descuento);
    l.importe    = l.precioDesc*l.cantidad;
  });
  renderCart();
}
function renderCart(){
  const tbody=$('cartBody'); tbody.innerHTML='';
  if(!cart.length){ tbody.innerHTML='<tr><td colspan="6" class="p-2 italic text-gray-500">Añade productos…</td></tr>'; updateTotals(0); return; }
  cart.forEach((l,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td class="p-1">${i+1}</td>
      <td class="p-1">${l.producto}</td>
      <td class="p-1 text-left">${l.descripcion}</td>
      <td class="p-1"><input type="number" min="1" value="${l.cantidad}" data-i="${i}" class="w-14 border rounded p-0.5 text-center"></td>
      <td class="p-1">${money(l.precioDesc)}</td>
      <td class="p-1">${money(l.importe)}</td>`;
    tbody.appendChild(tr);
  });
  tbody.querySelectorAll('input[type=number]').forEach(inp=> inp.onchange = e=>{ const i=+e.target.dataset.i; cart[i].cantidad=Math.max(1,+e.target.value); recalcCart(); });
  updateTotals(cart.reduce((s,l)=>s+l.importe,0));
}
function updateTotals(sub){
  $('subTotal').textContent = money(sub);
  const iva=sub*0.16; $('iva').textContent = money(iva);
  $('total').textContent = money(sub+iva);
}

/*************  PDF  *************/
function generarPDF(){
  if(!cart.length){ alert('Agrega productos al carrito'); return; }
  const fecha = $('fecha').value || new Date().toISOString().slice(0,10);
  const cliente = $('cliente').value || 'Cliente';
  const body = [[ 'Producto','Descripción','Cant','P.Unit','Total' ]].concat(
    cart.map(l=>[l.producto, l.descripcion, ''+l.cantidad, money(l.precioDesc), money(l.importe)])
  );
  const sub = cart.reduce((s,l)=>s+l.importe,0), iva=sub*0.16, total=sub+iva;
  const doc = {
    content:[
      { text:'COTIZACIÓN', style:'h1' },
      { text:`Fecha: ${fecha}   Cliente: ${cliente}\n\n` },
      { table:{ headerRows:1, widths:['*','*','auto','auto','auto'], body } },
      { text:`\nSubtotal: ${money(sub)}\nIVA (16%): ${money(iva)}\nTOTAL: ${money(total)}`, alignment:'right', margin:[0,10,0,0] },
      { text:'Cotización válida 30 días', fontSize:9, italics:true, margin:[0,20,0,0] }
    ],
    styles:{ h1:{ fontSize:16, bold:true, alignment:'center' } }
  };
  pdfMake.createPdf(doc).download(`Cotizacion_${cliente}_${fecha}.pdf`);
}

/*************  WHATSAPP  *************/
function shareWhats(){
  if(!cart.length){ alert('Agrega productos'); return; }
  const tel=$('whatsapp').value.trim(); if(!tel){ alert('Introduce el número WhatsApp'); return; }
  const total=$('total').textContent;
  const link=`https://wa.me/${tel}?text=${encodeURIComponent(`¡Hola! Te envío la cotización por ${total}.`)}\n`;
  window.open(link,'_blank');
}

/*************  EVENTOS UI *************/
['filterClave','filterDesc'].forEach(id=> $(id).addEventListener('input', filterProducts));
$('prevPage').onclick = ()=>{ currentPage--; renderProducts(); };
$('nextPage').onclick = ()=>{ currentPage++; renderProducts(); };
$('nivelPrecio').onchange = recalcCart;
$('btnPDF').onclick   = generarPDF;
$('btnWhats').onclick = shareWhats;
$('fecha').value = new Date().toISOString().slice(0,10);

/*************  START  *************/
loadCSV();
</script>
</body>
</html>
