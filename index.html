<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TPS – Cotizador</title>
  <!-- TailwindCSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- PapaParse -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
  <!-- pdfmake -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
</head>
<body class="bg-gray-100 min-h-screen p-4">
  <h1 class="text-2xl font-bold mb-4 text-center text-sky-700">Cotizador TPS</h1>
  <div class="grid md:grid-cols-3 gap-4">
    <!-- Catálogo -->
    <section class="md:col-span-2 bg-white shadow rounded-xl p-4">
      <h2 class="text-lg font-semibold mb-2">Catálogo de Productos</h2>
      <div id="errorMsg" class="text-red-600 text-sm mb-2 hidden"></div>
      <div class="flex gap-2 mb-3">
        <input id="filterClave" type="text" placeholder="Filtrar por Clave/Producto" class="w-1/2 border rounded p-2" />
        <input id="filterDesc" type="text" placeholder="Filtrar por Descripción" class="w-1/2 border rounded p-2" />
      </div>
      <div class="overflow-x-auto max-h-[420px]">
        <table class="w-full text-sm border">
          <thead>
            <tr class="bg-sky-700 text-white">
              <th class="p-2">Producto</th>
              <th class="p-2">Descripción</th>
              <th class="p-2">Precio</th>
              <th class="p-2">Añadir</th>
            </tr>
          </thead>
          <tbody id="productBody" class="divide-y"></tbody>
        </table>
      </div>
      <!-- Paginación -->
      <div class="flex justify-center items-center gap-2 mt-3">
        <button id="prevPage" class="px-3 py-1 bg-gray-200 rounded disabled:opacity-50">&lt;</button>
        <span id="pageInfo" class="text-sm"></span>
        <button id="nextPage" class="px-3 py-1 bg-gray-200 rounded disabled:opacity-50">&gt;</button>
      </div>
    </section>

    <!-- Resumen de Cotización -->
    <section class="bg-white shadow rounded-xl p-4 flex flex-col">
      <h2 class="text-lg font-semibold mb-2">Resumen de Cotización</h2>
      <div class="space-y-2 mb-2 overflow-y-auto max-h-60 pr-2">
        <input id="cliente" class="w-full border rounded p-2" placeholder="Nombre del cliente" />
        <input id="fecha" type="date" class="w-full border rounded p-2" />
        <input id="whatsapp" class="w-full border rounded p-2" placeholder="WhatsApp (Ej: 529991234...)" />
        <input id="folio" class="w-full border rounded p-2" placeholder="Folio (Opcional)" />
        <textarea id="comentario" rows="2" class="w-full border rounded p-2" placeholder="Comentario (Opcional)"></textarea>
      </div>
      <!-- Nivel de precio -->
      <label class="text-sm font-medium mb-1" for="nivelPrecio">Nivel de precio:</label>
      <select id="nivelPrecio" class="border rounded p-2 mb-3">
        <option value="0">Público (0%)</option>
        <option value="0.15">Sub‑distribuidor (15% desc.)</option>
        <option value="0.20">Distribuidor (20% desc.)</option>
      </select>

      <!-- Tabla de cotización -->
      <div class="overflow-x-auto flex-1">
        <table class="w-full text-xs border">
          <thead>
            <tr class="bg-sky-700 text-white">
              <th class="p-1">#</th><th class="p-1">Producto</th><th class="p-1">Desc.</th><th class="p-1">Cant</th><th class="p-1">UM</th><th class="p-1">P Unit</th><th class="p-1">Importe</th>
            </tr>
          </thead>
          <tbody id="cartBody" class="divide-y text-center">
            <tr><td colspan="7" class="p-2 italic text-gray-500">Añade productos…</td></tr>
          </tbody>
        </table>
      </div>

      <!-- Totales -->
      <div class="text-right mt-2 space-y-1 text-sm">
        <div>Subtotal: <span id="subTotal">$0.00</span></div>
        <div>IVA (16%): <span id="iva">$0.00</span></div>
        <div class="font-semibold text-lg">Total: <span id="total">$0.00</span></div>
      </div>

      <!-- Acciones -->
      <div class="flex gap-2 mt-4">
        <button id="btnWhats" class="flex-1 bg-green-500 hover:bg-green-600 text-white rounded p-2">WhatsApp</button>
        <button id="btnPDF" class="flex-1 bg-sky-600 hover:bg-sky-700 text-white rounded p-2">Generar PDF</button>
      </div>
    </section>
  </div>

<script>
// ----------------- Configuración -----------------
const CSV_URL = 'https://raw.githubusercontent.com/raulancona/cotizadortps/main/Lista%20estandar%20Raul.csv';
const ROWS_PER_PAGE = 10;
let products = [];
let filtered = [];
let currentPage = 1;
let cart = [];

// -------------- Utilidades ----------------
const formato = num => num.toLocaleString('es-MX', {style:'currency', currency:'MXN'});
function calcularPrecios() {
  const descuento = parseFloat(document.getElementById('nivelPrecio').value);
  cart.forEach(it => {
    it.descuento = descuento;
    it.precioUnitDesc = it.precio * (1 - descuento);
    it.importe = it.precioUnitDesc * it.cantidad;
  });
  renderCart();
}

function renderCart() {
  const tbody = document.getElementById('cartBody');
  tbody.innerHTML = '';
  if (cart.length === 0) {
    tbody.innerHTML = '<tr><td colspan="7" class="p-2 italic text-gray-500">Añade productos…</td></tr>';
    document.getElementById('subTotal').textContent = formato(0);
    document.getElementById('iva').textContent = formato(0);
    document.getElementById('total').textContent = formato(0);
    return;
  }
  cart.forEach((it, idx) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="p-1">${idx+1}</td>
      <td class="p-1">${it.producto}</td>
      <td class="p-1 text-left">${it.descripcion}</td>
      <td class="p-1"><input type="number" min="1" class="w-14 border rounded p-0.5 text-center" value="${it.cantidad}" data-idx="${idx}" /></td>
      <td class="p-1">PZA</td>
      <td class="p-1">${formato(it.precioUnitDesc)}</td>
      <td class="p-1">${formato(it.importe)}</td>`;
    tbody.appendChild(tr);
  });
  // Eventos de cantidad
  tbody.querySelectorAll('input[type=number]').forEach(inp => {
    inp.addEventListener('change', e => {
      const i = +e.target.dataset.idx;
      cart[i].cantidad = Math.max(1, +e.target.value);
      calularPrecios();
    });
  });
  const sub = cart.reduce((s, it) => s + it.importe, 0);
  document.getElementById('subTotal').textContent = formato(sub);
  const iva = sub * 0.16;
  document.getElementById('iva').textContent = formato(iva);
  document.getElementById('total').textContent = formato(sub + iva);
}

// ---------------- Productos ----------------
function renderProducts() {
  const tbody = document.getElementById('productBody');
  tbody.innerHTML = '';
  const start = (currentPage-1)*ROWS_PER_PAGE;
  const pageItems = filtered.slice(start, start + ROWS_PER_PAGE);
  pageItems.forEach(p => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="p-1">${p.producto}</td>
      <td class="p-1 text-left">${p.descripcion}</td>
      <td class="p-1 text-right">${formato(p.precio)}</td>
      <td class="p-1 text-center"><button class="bg-sky-600 hover:bg-sky-700 text-white rounded px-2 py-1 text-xs" data-prod="${p.producto}">+</button></td>`;
    tbody.appendChild(tr);
  });
  document.getElementById('pageInfo').textContent = `Página ${currentPage} / ${Math.max(1, Math.ceil(filtered.length/ROWS_PER_PAGE))}`;
  document.getElementById('prevPage').disabled = currentPage === 1;
  document.getElementById('nextPage').disabled = currentPage >= Math.ceil(filtered.length/ROWS_PER_PAGE);
  // Añadir eventos
  tbody.querySelectorAll('button').forEach(btn => {
    btn.addEventListener('click', () => addToCart(btn.dataset.prod));
  });
}

function filterProducts() {
  const clave = document.getElementById('filterClave').value.toLowerCase();
  const desc = document.getElementById('filterDesc').value.toLowerCase();
  filtered = products.filter(p =>
    (!clave || p.producto.toLowerCase().includes(clave)) &&
    (!desc || p.descripcion.toLowerCase().includes(desc))
  );
  currentPage = 1;
  renderProducts();
}

function addToCart(prodKey) {
  const item = products.find(p => p.producto === prodKey);
  const exists = cart.find(c => c.producto === prodKey);
  if (exists) { exists.cantidad += 1; } else {
    cart.push({ ...item, cantidad: 1, descuento: 0, precioUnitDesc: item.precio, importe: item.precio });
  }
  calularPrecios();
}

function loadCSV() {
  Papa.parse(CSV_URL, {
    download: true,
    header: true,
    complete: res => {
      products = res.data.filter(r => r.producto);
      // Limpieza & casting
      products = products.map(r => ({
        producto: r['producto'].trim(),
        descripcion: (r['Descripción ']||'').trim(),
        precio: parseFloat((r[' Precio ']||'0').replace(/,/g,'').trim()) || 0
      }));
      filtered = [...products];
      renderProducts();
    },
    error: err => {
      document.getElementById('errorMsg').textContent = 'Error al cargar productos: '+err.message;
      document.getElementById('errorMsg').classList.remove('hidden');
    }
  });
}

// ---------------- PDF ----------------
function generarPDF() {
  if (cart.length === 0) { alert('Agrega productos primero'); return; }
  const fecha = document.getElementById('fecha').value || new Date().toISOString().substring(0,10);
  const cliente = document.getElementById('cliente').value || 'Cliente';
  const comentario = document.getElementById('comentario').value;
  const bodyTable = [
    [{text:'Producto', bold:true}, {text:'Descripción', bold:true}, {text:'Cant', bold:true}, {text:'Precio', bold:true}, {text:'Total', bold:true}]
  ];
  cart.forEach(it => bodyTable.push([it.producto, it.descripcion, it.cantidad+'', formato(it.precioUnitDesc), formato(it.importe)]));
  const sub = cart.reduce((s,c)=>s+c.importe,0);
  const iva = sub*0.16;
  const total = sub+iva;
  const docDef = {
    pageMargins:[40,60,40,60],
    content:[
      {image:'', width:100, alignment:'left', margin:[0,0,0,10]}, // logo — cargar base64 si quieres
      {text:`COTIZACIÓN`, style:'header'},
      {columns:[
        {width:'*', text:`FECHA: ${fecha}\nCLIENTE: ${cliente}`},
        {width:'*', text:`Ven. TPS\nFolio: ${document.getElementById('folio').value||'-'}`}
      ], margin:[0,0,0,10]},
      comentario? {text:'DESCRIPCIÓN DEL PROYECTO:\n'+comentario, margin:[0,0,0,10]} : {},
      {table:{headerRows:1, widths:['*','*','auto','auto','auto'], body:bodyTable}},
      {text:`\nSubtotal: ${formato(sub)}\nIVA (16%): ${formato(iva)}\nTOTAL: ${formato(total)}`, alignment:'right', margin:[0,10,0,0]},
      {text:'\nCotización válida por 30 días', italics:true, fontSize:9}
    ],
    styles:{header:{fontSize:16,bold:true,alignment:'right'}}
  };
  pdfMake.createPdf(docDef).download(`Cotizacion_${cliente}.pdf`);
}

// --------------- WhatsApp ---------------
function shareWhats() {
  if (cart.length === 0) { alert('Agrega productos primero'); return; }
  const total = document.getElementById('total').textContent;
  const tel = document.getElementById('whatsapp').value.trim();
  const msg = encodeURIComponent(`¡Hola! Aquí está tu cotización por ${total}. Si tienes dudas avísame.`);
  const url = `https://wa.me/${tel}?text=${msg}`;
  window.open(url,'_blank');
}

// -------------- Eventos Init -------------
document.getElementById('filterClave').addEventListener('input', filterProducts);
document.getElementById('filterDesc').addEventListener('input', filterProducts);
document.getElementById('prevPage').addEventListener('click',()=>{currentPage--;renderProducts();});
document.getElementById('nextPage').addEventListener('click',()=>{currentPage++;renderProducts();});
document.getElementById('nivelPrecio').addEventListener('change',calcularPrecios);
document.getElementById('btnPDF').addEventListener('click',generarPDF);
document.getElementById('btnWhats').addEventListener('click',shareWhats);

// Autocompletar fecha hoy
if(!document.getElementById('fecha').value){document.getElementById('fecha').value=new Date().toISOString().substring(0,10);} 
// Cargar productos
loadCSV();
</script>
</body>
</html>
